##########################################################################################
# Tool: Fusion Compiler
# Script: Makefile_dp_hier
# Version: V-2023.12-SP4
# Copyright (C) 2014-2024 Synopsys, Inc. All rights reserved.
##########################################################################################

FC_EXEC = fc_shell
# To use the Clock Trunk Planning capability, change the value of CTP to true
CTP = false
OPTIONS = 

## LOGS_DIR value comes from rm_setup/design_setup.tcl; default is logs_fc
LOGS_DIR := $(subst $\",,$(shell expand rm_setup/design_setup.tcl | grep "^set LOGS_DIR" | awk '{print $$3}'))

##Optional: Specify design library if you want backup step and clean step to use it
##CAUTION: if added, the clean step will delete it
DESIGN_LIB =

console:
	$(FC_EXEC)

setup:
	test -d $(LOGS_DIR)	|| mkdir $(LOGS_DIR)
	touch setup

create_fusion_reference_library: setup
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_scripts/create_fusion_reference_library.tcl | tee -i $(LOGS_DIR)/create_fusion_reference_library.log

init_dp: setup
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/init_dp.tcl | tee -i $(LOGS_DIR)/init_dp.log

commit_blocks: setup init_dp
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/commit_blocks.tcl | tee -i $(LOGS_DIR)/commit_blocks.log

init_compile: setup commit_blocks
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/init_compile.tcl | tee -i $(LOGS_DIR)/init_compile.log

create_floorplan: setup init_compile
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/create_floorplan.tcl | tee -i $(LOGS_DIR)/create_floorplan.log

shaping: setup create_floorplan 
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/shaping.tcl | tee -i $(LOGS_DIR)/shaping.log

placement: setup shaping 
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/placement.tcl | tee -i $(LOGS_DIR)/placement.log

create_power: setup placement
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/create_power.tcl | tee -i $(LOGS_DIR)/create_power.log

ifeq ($(CTP),true)
clock_trunk_planning: setup create_power
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/clock_trunk_planning.tcl | tee -i $(LOGS_DIR)/clock_trunk_planning.log

place_pins: setup clock_trunk_planning
	rm -f place_pins.varfile
	echo > place_pins.varfile
	echo 'set PREVIOUS_STEP $${CLOCK_TRUNK_PLANNING_BLOCK_NAME}' >> place_pins.varfile
	export RM_VARFILE=place_pins.varfile; $(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/place_pins.tcl | tee -i $(LOGS_DIR)/place_pins.log
else
place_pins: setup create_power
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/place_pins.tcl | tee -i $(LOGS_DIR)/place_pins.log
endif

top_compile: setup place_pins
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/top_compile.tcl | tee -i $(LOGS_DIR)/top_compile.log

timing_budget: setup top_compile
	$(FC_EXEC) $(OPTIONS) -f ./rm_fc_dp_hier_scripts/timing_budget.tcl | tee -i $(LOGS_DIR)/timing_budget.log

write_data_dp: setup timing_budget
	rm -f write_data_dp.varfile
	echo > write_data_dp.varfile
	echo 'set rm_dp_flow true' >> write_data_dp.varfile
	echo 'set PREVIOUS_STEP $${BUDGETING_BLOCK_NAME}' >> write_data_dp.varfile
	export RM_VARFILE=write_data_dp.varfile; $(FC_EXEC) $(OPTIONS) -f ./rm_fc_scripts/write_data.tcl | tee -i $(LOGS_DIR)/write_data.log

all: setup write_data_dp
	grep "Diagnostics summary" $(LOGS_DIR)/*
	date > all

################################################################################################################
# Utilities Section
################################################################################################################

##Backup
BACKUP  = BACKUP.`date "+%m_%d_%H_%M"`
backup:
	rm -rf $(BACKUP)
	mkdir -p $(BACKUP)
	cp -rf $(DESIGN_LIB) $(LOGS_DIR) $(BACKUP)

clean:
	rm -rf create_fusion_reference_library init_dp commit_blocks init_compile create_floorplan shaping placement create_power clock_trunk_planning place_pins top_compile timing_budget write_data_dp all
	rm -rf *.err *.log

clean_all: clean
	rm -rf setup split_constraints $(LOGS_DIR) ./rpts_fc ./outputs_fc ./images ./split ./block_budgets
	rm -rf fc_output.txt check_design*.ems default*.svf ./block_pg ./pgroute_output ./work ./work_dir compare_qor_data qor_data
